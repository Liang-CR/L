<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>播放器</title>

    <!-- 资源预加载 -->
    <link rel="preconnect" href="https://unpkg.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://unpkg.com">
    
    <!-- 样式表 -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Tailwind CSS CDN -->
    <script src="libs/tailwindcss.min.js"></script>

    <style>
        /* 播放器基础样式 */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: #0f1622;
            color: white;
        }
        
        .player-container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        #player {
            width: 100%;
            height: 60vh; /* 视频播放器高度 */
        }
        
        /* 加载动画样式 */
        .loading-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            z-index: 100;
            flex-direction: column;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 错误提示样式 */
        .error-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            z-index: 100;
            flex-direction: column;
            text-align: center;
            padding: 1rem;
        }
        
        .error-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }
        
        /* 集数按钮样式 */
        .episode-active {
            background-color: #3b82f6 !important;
            border-color: #60a5fa !important;
        }
        
        .episode-grid {
            max-height: 30vh;
            overflow-y: auto;
            padding: 1rem 0;
        }
        
        /* 开关样式 */
        .switch {
            position: relative;
            display: inline-block;
            width: 46px;
            height: 24px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #00ccff;
        }
        
        input:checked + .slider:before {
            transform: translateX(22px);
        }
        
        /* 快捷键提示样式 */
        .shortcut-hint {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .shortcut-hint.show {
            opacity: 1;
        }
        
        /* 全屏样式优化 */
        .player-container:-webkit-full-screen,
        .player-container:fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 10000;
            background-color: #000;
        }
        
        .player-container:-webkit-full-screen #player,
        .player-container:fullscreen #player {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <!-- 页面头部 -->
    <header class="bg-[#111] p-4 flex justify-between items-center border-b border-[#333]">
        <div class="flex items-center">
            <a href="index.html" class="flex items-center">
                <svg class="w-8 h-8 mr-2 text-[#00ccff]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z">
                    </path>
                </svg>
                <h1 class="text-xl font-bold gradient-text">X</h1>
            </a>
        </div>
        <h2 id="videoTitle" class="text-xl font-semibold truncate flex-1 text-center"></h2>
        <a href="index.html" 
           class="px-4 py-2 bg-[#222] hover:bg-[#333] border border-[#333] rounded-lg transition-colors">
            返回首页
        </a>
    </header>

    <!-- 密码验证弹窗 -->
    <div id="passwordModal" 
         class="fixed inset-0 bg-black/95 hidden items-center justify-center z-[65] transition-opacity duration-300">
        <div class="bg-[#111] p-8 rounded-lg w-11/12 max-w-md border border-[#333] max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center mb-6 flex-none">
                <h2 class="text-2xl font-bold gradient-text">访问验证</h2>
            </div>
            <div class="mb-6">
                <p class="text-gray-300 mb-4">请输入密码继续访问</p>
                <form id="passwordForm" onsubmit="handlePasswordSubmit(); return false;">
                    <input type="text" name="username" id="username" autocomplete="username" 
                           style="display:none" tabindex="-1" aria-hidden="true">
                    <input type="password" id="passwordInput" 
                           class="w-full bg-[#111] border border-[#333] text-white px-4 py-3 rounded-lg focus:outline-none focus:border-white transition-colors"
                           placeholder="密码..." autocomplete="new-password">
                    <button id="passwordSubmitBtn" type="submit" 
                            class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                        提交
                    </button>
                </form>
                <p id="passwordError" class="text-red-500 mt-2 hidden">密码错误，请重试</p>
            </div>
        </div>
    </div>

    <!-- 播放器容器 -->
    <main class="container mx-auto px-4 py-4">
        <!-- 播放区 -->
        <div id="playerContainer" class="player-container">
            <div class="relative">
                <div id="player"></div>
                <div class="loading-container" id="loading">
                    <div class="loading-spinner"></div>
                    <div>正在加载视频...</div>
                </div>
                <div class="error-container" id="error">
                    <div class="error-icon">⚠️</div>
                    <div id="error-message">视频加载失败</div>
                    <div style="margin-top: 10px; font-size: 14px; color: #aaa;">
                        请尝试其他视频源或稍后重试
                    </div>
                </div>
            </div>
        </div>

        <!-- 集数导航 -->
        <div class="player-container">
            <div class="flex justify-between items-center my-4">
                <button onclick="playPreviousEpisode()" 
                        id="prevButton" 
                        class="px-4 py-2 bg-[#222] hover:bg-[#333] border border-[#333] rounded-lg transition-colors">
                    <svg class="w-5 h-5 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M15 19l-7-7 7-7"></path>
                    </svg>
                    上一集
                </button>
                <span class="text-gray-400" id="episodeInfo">加载中...</span>
                <button onclick="playNextEpisode()" 
                        id="nextButton" 
                        class="px-4 py-2 bg-[#222] hover:bg-[#333] border border-[#333] rounded-lg transition-colors">
                    下一集
                    <svg class="w-5 h-5 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- 功能控件 -->
        <div class="player-container">
            <div class="flex justify-end items-center mb-4 gap-2">
                <span class="text-gray-400 text-sm">自动连播</span>
                <label class="switch">
                    <input type="checkbox" id="autoplayToggle">
                    <span class="slider"></span>
                </label>
                <button onclick="toggleEpisodeOrder()" 
                        class="ml-4 px-4 py-2 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 text-white font-semibold rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex items-center justify-center space-x-2">
                    <svg id="orderIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                              d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11v3.586L7.707 9.293a1 1 0 00-1.414 1.414l3 3a1 1 0 001.414 0l3-3a1 1 0 00-1.414-1.414L11 10.586V7z" />
                    </svg>
                    <span id="orderText">倒序排列</span>
                </button>
                <button id="lockToggle" onclick="toggleControlsLock()" title="锁定控制" 
                        class="px-2 py-1 bg-[#333] hover:bg-[#444] text-white rounded-full transition">
                    <svg id="lockIcon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M15 11V7a3 3 0 00-6 0v4m-3 4h12v6H6v-6z" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- 集数网格 -->
        <div class="player-container">
            <div class="episode-grid" id="episodesGrid">
                <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2" id="episodesList">
                    <div class="col-span-full text-center text-gray-400 py-8">加载中...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- 快捷键提示 -->
    <div class="shortcut-hint" id="shortcutHint">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M15 19l-7-7 7-7"></path>
        </svg>
        <span id="shortcutText"></span>
    </div>

    <!-- 脚本资源 -->
    <!-- 加载SHA-256实现 -->
    <script src="libs/sha256.min.js"></script>
    <script>
        // 保存原始 js‑sha256 实现，避免被覆盖
        window._jsSha256 = window.sha256;
    </script>
    
    <!-- 加载播放器库 -->
    <script src="libs/hls.min.js" crossorigin="anonymous"></script>
    <script src="libs/DPlayer.min.js" crossorigin="anonymous"></script>

    <!-- 加载配置和功能脚本 -->
    <script src="js/config.js"></script>
    <script src="js/password.js"></script>

    <!-- 环境变量注入 -->
    <script>
        // 创建全局环境变量对象
        window.__ENV__ = window.__ENV__ || {};
        // 注入服务器端环境变量
        window.__ENV__.PASSWORD = "{{PASSWORD}}";
    </script>

    <!-- 播放器核心逻辑 -->
    <script>
        // 全局变量
        let currentVideoTitle = '';
        let currentEpisodeIndex = 0;
        let currentEpisodes = [];
        let episodesReversed = false;
        let dp = null;
        let currentHls = null; // 跟踪当前HLS实例
        let autoplayEnabled = true; // 默认开启自动连播
        let isUserSeeking = false; // 跟踪用户是否正在拖动进度条
        let videoHasEnded = false; // 跌踪视频是否自然结束
        let userClickedPosition = null; // 记录用户点击的位置
        let shortcutHintTimeout = null; // 快捷键提示定时器
        let progressSaveInterval = null; // 进度保存定时器

        // 页面加载
        document.addEventListener('DOMContentLoaded', function() {
            // 检查用户是否已通过密码验证
            if (!isPasswordVerified()) {
                document.getElementById('loading').style.display = 'none';
                return;
            }
            
            initializePageContent();
        });

        // 密码验证成功后重新加载
        document.addEventListener('passwordVerified', () => {
            document.getElementById('loading').style.display = 'block';
            initializePageContent();
        });

        // 初始化页面内容
        function initializePageContent() {
            const urlParams = new URLSearchParams(window.location.search);
            const videoUrl = urlParams.get('url');
            const title = urlParams.get('title');
            const sourceCode = urlParams.get('source_code');
            let index = parseInt(urlParams.get('index') || '0');
            const episodesList = urlParams.get('episodes');

            // 从URL或localStorage获取数据
            currentVideoTitle = title || localStorage.getItem('currentVideoTitle') || '未知视频';
            currentEpisodeIndex = index;
            
            // 自动连播开关状态
            autoplayEnabled = localStorage.getItem('autoplayEnabled') !== 'false';
            const autoplayToggle = document.getElementById('autoplayToggle');
            if (autoplayToggle) autoplayToggle.checked = autoplayEnabled;
            
            // 广告过滤设置
            adFilteringEnabled = localStorage.getItem(PLAYER_CONFIG.adFilteringStorage) !== 'false';
            
            // 自动连播开关监听
            if (autoplayToggle) {
                autoplayToggle.addEventListener('change', function(e) {
                    autoplayEnabled = e.target.checked;
                    localStorage.setItem('autoplayEnabled', autoplayEnabled);
                });
            }
            
            // 优先使用URL传递的集数信息，否则从localStorage获取
            try {
                if (episodesList) {
                    currentEpisodes = JSON.parse(decodeURIComponent(episodesList));
                    console.log('从URL恢复集数信息:', currentEpddles.length);
                } else {
                    currentEpisodes = JSON.parse(localStorage.getItem('currentEpisodes') || '[]');
                    console.log('从localStorage恢复集数信息:', currentEpisodes.length);
                }
                
                // 校验索引有效性
                if (index < 0 || (currentEpisodes.length > 0 && index >= currentEpisodes.length)) {
                    if (currentEpisodes.length > 0 && index >= currentEpisodes.length) {
                        index = currentEpisodes.length - 1;
                    } else {
                        index = 0;
                    }
                    
                    // 更新URL以反映修正后的索引
                    const newUrl = new URL(window.location.href);
                    newUrl.searchParams.set('index', index);
                    window.history.replaceState({}, '', newUrl);
                }
                
                currentEpisodeIndex = index;
                episodesReversed = localStorage.getItem('episodesReversed') === 'true';
            } catch (e) {
                console.error('获取集数信息失败:', e);
                currentEpisodes = [];
                currentEpisodeIndex = 0;
                episodesReversed = false;
            }

            // 设置页面标题
            document.title = `${currentVideoTitle} - 播放器`;
            document.getElementById('videoTitle').textContent = currentVideoTitle;

            // 初始化播放器
            if (videoUrl) {
                initPlayer(videoUrl, sourceCode);
                
                // 尝试从URL参数中恢复播放位置
                const position = urlParams.get('position');
                if (position) {
                    setTimeout(() => {
                        if (dp?.video) {
                            const positionNum = parseInt(position);
                            if (!isNaN(positionNum) && positionNum > 0) {
                                dp.seek(positionNum);
                                showPositionRestoreHint(positionNum);
                            }
                        }
                    }, 1500);
                }
            } else {
                showError('无效的视频链接');
            }

            // 更新集数信息
            updateEpisodeInfo();
            // 渲染集数列表
            renderEpisodes();
            // 更新按钮状态
            updateButtonStates();
            // 更新排序按钮
            updateOrderButton();

            // 添加进度条精确点击
            setTimeout(() => {
                setupProgressBarPreciseClicks();
            }, 1000);

            // 键盘快捷键
            document.addEventListener('keydown', handleKeyboardShortcuts);

            // 页面关闭前保存进度
            window.addEventListener('beforeunload', saveCurrentProgress);

            // 页面隐藏时保存进度
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') {
                    saveCurrentProgress();
                }
            });

            // 播放器就绪后添加事件监听
            const waitForVideo = setInterval(() => {
                if (dp?.video) {
                    dp.video.addEventListener('pause', saveCurrentProgress);
                    // 每5秒保存一次进度
                    dp.video.addEventListener('timeupdate', () => {
                        const now = Date.now();
                        if (now - lastSave > 5000) {
                            saveCurrentProgress();
                            lastSave = now;
                        }
                    });
                    clearInterval(waitForVideo);
                }
            }, 200);
        }

        // 处理键盘快捷键
        function handleKeyboardShortcuts(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            if (e.altKey && e.key === 'ArrowLeft') {
                if (currentEpisodeIndex > 0) {
                    playPreviousEpisode();
                    showShortcutHint('上一集', 'left');
                    e.preventDefault();
                }
            }
            
            if (e.altKey && e.key === 'ArrowRight') {
                if (currentEpisodeIndex < currentEpisodes.length - 1) {
                    playNextEpisode();
                    showShortcutHint('下一集', 'right');
                    e.preventDefault();
                }
            }
        }

        // 显示快捷键提示
        function showShortcutHint(text, direction) {
            const hintElement = document.getElementById('shortcutHint');
            const textElement = document.getElementById('shortcutText');
            const iconElement = document.getElementById('shortcutIcon');
            
            if (shortcutHintTimeout) {
                clearTimeout(shortcutHintTimeout);
            }
            
            // 设置文本和图标
            textElement.textContent = text;
            iconElement.innerHTML = direction === 'left'
                ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>'
                : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>';
            
            // 显示提示
            hintElement.classList.add('show');
            shortcutHintTimeout = setTimeout(() => {
                hintElement.classList.remove('show');
            }, 2000);
        }

        // 初始化播放器
        function initPlayer(videoUrl, sourceCode) {
            if (!videoUrl) return;

            window.filterAdPattern = API_SITES[sourceCode]?.filterAdRule || null;

            // HLS配置
            const hlsConfig = {
                debug: false,
                loader: (adFilteringEnabled && API_SITES[sourceCode]?.filterAdRule) ? CustomHlsJsLoader : Hls.DefaultConfig.loader,
                enableWorker: true,
                lowLatencyMode: false,
                backBufferLength: 90,
                maxBufferLength: 30,
                maxMaxBufferLength: 60,
                maxBufferSize: 30 * 1000 * 1000,
                maxBufferHole: 0.5,
                fragLoadingMaxRetry: 6,
                fragLoadingMaxRetryTimeout: 64000,
                fragLoadingRetryDelay: 1000,
                manifestLoadingMaxRetry: 3,
                manifestLoadingRetryDelay: 1000,
                levelLoadingMaxRetry: 4,
                levelLoadingRetryDelay: 1000,
                startLevel: -1,
                abrEwmaDefaultEstimate: 500000,
                abrBandWidthFactor: 0.95,
                abrBandWidthUpFactor: 0.7,
                abrMaxWithRealBitrate: true,
                stretchShortVideoTrack: true,
                appendErrorMaxRetry: 5,
                liveSyncDurationCount: 3,
                liveDurationInfinity: false
            };
            
            // DPlayer配置
            dp = new DPlayer({
                container: document.getElementById('player'),
                autoplay: true,
                theme: '#00ccff',
                preload: 'auto',
                loop: false,
                lang: 'zh-cn',
                hotkey: true,
                mutex: true,
                volume: 0.7,
                screenshot: true,
                preventClickToggle: false,
                airplay: true,
                chromecast: true,
                video: {
                    url: videoUrl,
                    type: 'hls',
                    pic: 'https://img.picgo.net/2025/04/12/image362e7d38b4af4a74.png',
                    customType: {
                        hls: function(video, player) {
                            if (currentHls && currentHls.destroy) {
                                try { currentHls.destroy(); } catch (e) {
                                    console.warn('销毁旧HLS实例出错:', e);
                                }
                            }
                            
                            const hls = new Hls(hlsConfig);
                            currentHls = hls;
                            let errorDisplayed = false;
                            let errorCount = 0;
                            let playbackStarted = false;
                            let bufferAppendErrorCount = 0;
                            
                            // 监听视频播放事件
                            video.addEventListener('playing', () => {
                                playbackStarted = true;
                                document.getElementById('loading').style.display = 'none';
                                document.getElementById('error').style.display = 'none';
                            });
                            
                            // 监听视频进度
                            video.addEventListener('timeupdate', () => {
                                if (video.currentTime > 1) {
                                    document.getElementById('error').style.display = 'none';
                                }
                            });

                            hls.loadSource(video.src);
                            hls.attachMedia(video);
                            
                            // 启用AirPlay
                            const source = document.createElement('source');
                            source.src = videoUrl;
                            video.appendChild(source);
                            video.disableRemotePlayback = false;
                            
                            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                                video.play().catch(e => {
                                    console.warn('自动播放被阻止:', e);
                                });
                            });
                            
                            hls.on(Hls.Events.ERROR, (event, data) => {
                                errorCount++;
                                
                                // bufferAppendError处理
                                if (data.details === 'bufferAppendError') {
                                    bufferAppendErrorCount++;
                                    if (playbackStarted) return;
                                    if (bufferAppendErrorCount >= 3) hls.recoverMediaError();
                                }
                                
                                // 致命错误处理
                                if (data.fatal && !playbackStarted) {
                                    console.error('致命HLS错误:', data);
                                    switch(data.type) {
                                        case Hls.ErrorTypes.NETWORK_ERROR:
                                            hls.startLoad();
                                            break;
                                        case Hls.ErrorTypes.MEDIA_ERROR:
                                            hls.recoverMediaError();
                                            break;
                                        default:
                                            if (errorCount > 3 && !errorDisplayed) {
                                                errorDisplayed = true;
                                                showError('视频加载失败，可能是格式不兼容或源不可用');
                                            }
                                            break;
                                    }
                                }
                            });
                            
                            hls.on(Hls.Events.FRAG_LOADED, () => {
                                document.getElementById('loading').style.display = 'none';
                            });
                            
                            hls.on(Hls.Events.LEVEL_LOADED, () => {
                                document.getElementById('loading').style.display = 'none';
                            });
                        }
                    }
                }
            });
            
            // 全屏方向锁定
            dp.on('fullscreen', () => {
                if (window.screen.orientation?.lock) {
                    window.screen.orientation.lock('landscape')
                        .then(() => console.log('屏幕已锁定为横向模式'))
                        .catch((error) => console.warn('无法锁定屏幕方向:', error));
                } else {
                    console.warn('当前浏览器不支持屏幕方向锁定');
                }
            });
            
            dp.on('fullscreen_cancel', () => {
                if (window.screen.orientation?.unlock) {
                    window.screen.orientation.unlock();
                }
            });

            dp.on('loadedmetadata', () => {
                document.getElementById('loading').style.display = 'none';
                videoHasEnded = false;
                setupProgressBarPreciseClicks();
                setTimeout(saveToHistory, 3000);
                startProgressSaveInterval();
            });

            dp.on('error', () => {
                if (dp.video?.currentTime > 1) return;
                showError('视频播放失败，请检查视频源或网络连接');
            });
            
            // seek事件处理
            dp.on('seeking', () => {
                isUserSeeking = true;
                videoHasEnded = false;
                if (userClickedPosition !== null && dp.video) {
                    const clickedTime = userClickedPosition;
                    if (Math.abs(dp.video.duration - clickedTime) < 0.5) {
                        dp.video.currentTime = Math.max(0, clickedTime - 0.5);
                    } else {
                        dp.video.currentTime = clickedTime;
                    }
                    setTimeout(() => userClickedPosition = null, 200);
                }
            });
            
            dp.on('seeked', () => {
                if (dp.video && dp.video.duration - dp.video.currentTime < 0.3 && isUserSeeking) {
                    dp.video.currentTime = Math.max(0, dp.video.currentTime - 1);
                }
                
                setTimeout(() => isUserSeeking = false, 200);
            });
            
            // 视频结束处理
            dp.on('ended', () => {
                videoHasEnded = true;
                clearVideoProgress();
                
                if (autoplayEnabled && currentEpisodeIndex < currentEpisodes.length - 1) {
                    setTimeout(() => {
                        if (videoHasEnded && !isUserSeeking) {
                            playNextEpisode();
                            videoHasEnded = false;
                        }
                    }, 1000);
                }
            });
            
            // 时间更新处理
            dp.on('timeupdate', () => {
                if (dp.video && dp.video.currentTime > dp.video.duration * 0.95 && isUserSeeking) {
                    videoHasEnded = false;
                }
            });
            
            // 10秒后显示加载提示
            setTimeout(() => {
                if (dp?.video?.currentTime > 0) return;
                if (document.getElementById('loading').style.display !== 'none') {
                    document.getElementById('loading').innerHTML = `
                        <div class="loading-spinner"></div>
                        <div>视频加载时间较长，请耐心等待...</div>
                        <div style="font-size: 12px; color: #aaa; margin-top: 10px;">
                            如长时间无响应，请尝试其他视频源
                        </div>
                    `;
                }
            }, 10000);
            
            // 原生全屏
            (function(){
                const fsContainer = document.getElementById('playerContainer');
                dp.on('fullscreen', () => {
                    fsContainer.requestFullscreen?.()
                        .catch(err => console.warn('原生全屏失败:', err));
                });
                
                dp.on('fullscreen_cancel', () => {
                    document.exitFullscreen?.();
                });
            })();
        }

        // 自定义M3U8 Loader
        class CustomHlsJsLoader extends Hls.DefaultConfig.loader {
            constructor(config) {
                super(config);
                const load = this.load.bind(this);
                this.load = function(context, config, callbacks) {
                    if (context.type === 'manifest' || context.type === 'level') {
                        const onSuccess = callbacks.onSuccess;
                        callbacks.onSuccess = function(response, stats, context) {
                            if (response.data && typeof response.data === 'string') {
                                response.data = filterAdsFromM3U8(response.data, true);
                            }
                            return onSuccess(response, stats, context);
                        };
                    }
                    load(context, config, callbacks);
                };
            }
        }

        // M3U8广告过滤
        function filterAdsFromM3U8(m3u8Content, strictMode = false) {
            if (!m3u8Content) return '';
            if (window.filterAdPattern) {
                const regex = new RegExp(window.filterAdPattern, 'g');
                return m3u8Content.replace(regex, '');
            }
            return m3u8Content;
        }

        // 显示错误
        function showError(message) {
            if (dp?.video?.currentTime > 1) return;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'flex';
            document.getElementById('error-message').textContent = message;
        }

        // 更新集数信息
        function updateEpisodeInfo() {
            const infoEl = document.getElementById('episodeInfo');
            infoEl.textContent = currentEpisodes.length > 0 
                ? `第 ${currentEpisodeIndex + 1}/${currentEpisodes.length} 集`
                : '无集数信息';
        }

        // 更新按钮状态
        function updateButtonStates() {
            const prevButton = document.getElementById('prevButton');
            const nextButton = document.getElementById('nextButton');
            
            if (currentEpisodeIndex > 0) {
                prevButton.classList.remove('bg-gray-700', 'cursor-not-allowed');
                prevButton.classList.add('bg-[#222]', 'hover:bg-[#333]');
                prevButton.removeAttribute('disabled');
            } else {
                prevButton.classList.add('bg-gray-700', 'cursor-not-allowed');
                prevButton.classList.remove('bg-[#222]', 'hover:bg-[#333]');
                prevButton.setAttribute('disabled', '');
            }
            
            if (currentEpisodeIndex < currentEpisodes.length - 1) {
                nextButton.classList.remove('bg-gray-700', 'cursor-not-allowed');
                nextButton.classList.add('bg-[#222]', 'hover:bg-[#333]');
                nextButton.removeAttribute('disabled');
            } else {
                nextButton.classList.add('bg-gray-700', 'cursor-not-allowed');
                nextButton.classList.remove('bg-[#222]', 'hover:bg-[#333]');
                nextButton.setAttribute('disabled', '');
            }
        }

        // 渲染集数按钮
        function renderEpisodes() {
            const episodesList = document.getElementById('episodesList');
            if (!episodesList) return;
            
            if (!currentEpisodes.length) {
                episodesList.innerHTML = '<div class="col-span-full text-center text-gray-400 py-8">没有可用的集数</div>';
                return;
            }
            
            const episodes = episodesReversed ? [...currentEpisodes].reverse() : currentEpisodes;
            let html = '';
            
            episodes.forEach((episode, index) => {
                const realIndex = episodesReversed 
                    ? currentEpisodes.length - 1 - index 
                    : index;
                const isActive = realIndex === currentEpisodeIndex;
                
                html += `
                    <button id="episode-${realIndex}" 
                            onclick="playEpisode(${realIndex})" 
                            class="px-4 py-2 ${isActive ? 'episode-active' : 'bg-[#222] hover:bg-[#333]'} 
                                   border ${isActive ? 'border-blue-500' : 'border-[#333]'} 
                                   rounded-lg transition-colors text-center episode-btn">
                        第${realIndex + 1}集
                    </button>
                `;
            });
            
            episodesList.innerHTML = html;
        }

        // 播放指定集数
        function playEpisode(index) {
            if (index < 0 || index >= currentEpisodes.length) {
                showToast(`无效的剧集索引: ${index + 1}，当前剧集总数: ${currentEpisodes.length}`);
                return;
            }
            
            if (dp && dp.video && !dp.video.paused && !videoHasEnded) {
                saveCurrentProgress();
            }
            
            if (progressSaveInterval) {
                clearInterval(progressSaveInterval);
                progressSaveInterval = null;
            }
            
            document.getElementById('error').style.display = 'none';
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading').innerHTML = `
                <div class="loading-spinner"></div>
                <div>正在加载视频...</div>
            `;
                        currentEpisodeIndex = index;
            updateEpisodeInfo();
            updateButtonStates();
            renderEpisodes();

            // 构建新URL
            const newUrl = new URL(window.location.href);
            newUrl.searchParams.set('index', index);
            
            // 如果当前有标题，也保留标题参数
            if (currentVideoTitle) {
                newUrl.searchParams.set('title', currentVideoTitle);
            }
            
            // 替换URL但不刷新页面
            window.history.replaceState({}, '', newUrl);

            // 获取新视频URL
            const newVideoUrl = currentEpisodes[index];
            if (newVideoUrl) {
                // 重新初始化播放器
                initPlayer(newVideoUrl, newUrl.searchParams.get('source_code'));
                
                // 预加载下几集
                if (autoplayEnabled && PLAYER_CONFIG.enablePreloading) {
                    prefetchAllNextEpisodes(index);
                }
            } else {
                showError('无法获取该集数的视频链接');
            }
        }

        // 预加载下几集
        function prefetchAllNextEpisodes(startIndex) {
            const preloadCount = PLAYER_CONFIG.preloadCount || 2;
            const maxIndex = Math.min(startIndex + preloadCount, currentEpisodes.length);
            
            for (let i = startIndex + 1; i < maxIndex; i++) {
                if (currentEpisodes[i] && !window[`_prefetch_${i}`]) {
                    prefetchEpisode(currentEpisodes[i], i);
                }
            }
        }

        // 预加载单个集数
        function prefetchEpisode(url, index) {
            if (!url) return;
            
            // 创建隐藏的video元素用于预加载
            const prefetchVideo = document.createElement('video');
            prefetchVideo.preload = 'auto';
            prefetchVideo.muted = true;
            prefetchVideo.src = url;
            
            // 保存到全局变量
            window[`_prefetch_${index}`] = prefetchVideo;
            
            // 5秒后释放资源
            setTimeout(() => {
                if (window[`_prefetch_${index}`]) {
                    window[`_prefetch_${index}`].src = '';
                    delete window[`_prefetch_${index}`];
                }
            }, 5000);
        }

        // 播放下一集
        function playNextEpisode() {
            if (currentEpisodeIndex < currentEpisodes.length - 1) {
                playEpisode(currentEpisodeIndex + 1);
                return true;
            }
            return false;
        }

        // 播放上一集
        function playPreviousEpisode() {
            if (currentEpisodeIndex > 0) {
                playEpisode(currentEpisodeIndex - 1);
                return true;
            }
            return false;
        }

        // 切换集数排序
        function toggleEpisodeOrder() {
            episodesReversed = !episodesReversed;
            localStorage.setItem('episodesReversed', episodesReversed);
            renderEpisodes();
            updateOrderButton();
        }

        // 更新排序按钮状态
        function updateOrderButton() {
            const icon = document.getElementById('orderIcon');
            const text = document.getElementById('orderText');
            
            if (episodesReversed) {
                icon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M14 5l7 7m0 0l-7 7m7-7H3" />
                `;
                text.textContent = '正序排列';
            } else {
                icon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                `;
                text.textContent = '倒序排列';
            }
        }

        // 锁定控制
        function toggleControlsLock() {
            const lockIcon = document.getElementById('lockIcon');
            const playerContainer = document.getElementById('playerContainer');
            
            playerContainer.classList.toggle('locked');
            
            if (playerContainer.classList.contains('locked')) {
                lockIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                `;
            } else {
                lockIcon.innerHTML = `
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M15 11V7a3 3 0 00-6 0v4m-3 4h12v6H6v-6z" />
                `;
            }
        }

        // 进度保存相关
        let lastSave = 0;
        let currentPlaybackPosition = 0;

        // 开始定期保存进度
        function startProgressSaveInterval() {
            if (progressSaveInterval) {
                clearInterval(progressSaveInterval);
            }
            
            progressSaveInterval = setInterval(() => {
                if (dp?.video && dp.video.duration > 10 && !isUserSeeking) {
                    currentPlaybackPosition = dp.video.currentTime;
                }
            }, 5000);
        }

        // 保存当前进度到历史记录
        function saveCurrentProgress() {
            if (!dp?.video || dp.video.duration < 10 || isUserSeeking) return;
            
            // 获取当前视频信息
            const currentUrl = window.location.href;
            const currentDuration = dp.video.duration;
            const currentPosition = dp.video.currentTime;
            
            // 创建视频信息对象
            const videoInfo = {
                title: currentVideoTitle,
                url: currentUrl,
                episodeIndex: currentEpisodeIndex,
                playbackPosition: currentPosition,
                duration: currentDuration,
                timestamp: Date.now(),
                sourceName: new URLSearchParams(window.location.search).get('source_code') || '未知来源',
                episodes: currentEpisodes
            };
            
            // 添加到观看历史
            addToViewingHistory(videoInfo);
        }

        // 清除当前视频进度
        function clearVideoProgress() {
            currentPlaybackPosition = 0;
            if (progressSaveInterval) {
                clearInterval(progressSaveInterval);
                progressSaveInterval = null;
            }
        }

        // 设置进度条精确点击
        function setupProgressBarPreciseClicks() {
            if (!dp?.video || !dp.container) return;
            
            const progressBar = dp.container.querySelector('.dplayer-bar-wrap');
            if (!progressBar) return;
            
            progressBar.addEventListener('click', (e) => {
                const rect = progressBar.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const barWidth = rect.width;
                const percentage = clickX / barWidth;
                
                userClickedPosition = dp.video.duration * percentage;
                dp.seek(userClickedPosition);
            });
        }

        // 显示位置恢复提示
        function showPositionRestoreHint(position) {
            const minutes = Math.floor(position / 60);
            const seconds = Math.floor(position % 60);
            showToast(`已跳转到 ${minutes}:${seconds.toString().padStart(2, '0')}`, 'info');
        }

        // 页面卸载前保存进度
        function saveToHistory() {
            if (!dp?.video) return;
            
            const videoInfo = {
                title: currentVideoTitle,
                url: window.location.href,
                episodeIndex: currentEpisodeIndex,
                playbackPosition: dp.video.currentTime,
                duration: dp.video.duration,
                timestamp: Date.now(),
                sourceName: new URLSearchParams(window.location.search).get('source_code') || '未知来源',
                episodes: currentEpisodes
            };
            
            window.parent.postMessage({ type: 'addToHistory', data: videoInfo }, '*');
        }

        // 处理来自父窗口的消息
        window.addEventListener('message', function(event) {
            if (event.data.type === 'addToHistory') {
                try {
                    localStorage.setItem('currentVideoTitle', event.data.data.title);
                    localStorage.setItem('currentEpisodes', JSON.stringify(event.data.data.episodes));
                } catch (e) {
                    console.error('保存当前视频信息失败:', e);
                }
            }
        });

        // 密码验证成功后的回调
        function handlePasswordSubmit() {
            const passwordInput = document.getElementById('passwordInput');
            const passwordError = document.getElementById('passwordError');
            const passwordSubmitBtn = document.getElementById('passwordSubmitBtn');
            
            if (!passwordInput || !passwordError || !passwordSubmitBtn) return;
            
            const enteredPassword = passwordInput.value;
            const hashedPassword = window._jsSha256(enteredPassword);
            
            passwordSubmitBtn.disabled = true;
            passwordSubmitBtn.textContent = '验证中...';
            
            // 延迟执行以显示加载状态
            setTimeout(() => {
                if (hashedPassword === window.__ENV__.PASSWORD) {
                    localStorage.setItem(window.PASSWORD_CONFIG.localStorageKey, 'true');
                    document.getElementById('passwordModal').classList.add('hidden');
                    document.getElementById('passwordForm').reset();
                    passwordError.classList.add('hidden');
                    passwordSubmitBtn.disabled = false;
                    passwordSubmitBtn.textContent = '提交';
                    
                    // 触发密码验证成功事件
                    const event = new CustomEvent('passwordVerified');
                    document.dispatchEvent(event);
                } else {
                    passwordError.textContent = '密码错误，请重试';
                    passwordError.classList.remove('hidden');
                    passwordSubmitBtn.disabled = false;
                    passwordSubmitBtn.textContent = '提交';
                }
            }, 300);
        }

        // 检查密码验证状态
        function isPasswordVerified() {
            const verified = localStorage.getItem(window.PASSWORD_CONFIG.localStorageKey);
            const expired = verified === 'true' && 
                           (Date.now() - localStorage.getItem(window.PASSWORD_CONFIG.localStorageKey + '_timestamp') > window.PASSWORD_CONFIG.verificationTTL);
            
            if (verified === 'true' && !expired) {
                return true;
            }
            
            // 如果有密码保护，显示密码弹窗
            if (window.isPasswordProtected && window.isPasswordProtected()) {
                document.getElementById('passwordModal').classList.remove('hidden');
                return false;
            }
            
            return true;
        }

        // 显示Toast消息
        function showToast(message, type = 'error') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            if (!toast || !toastMessage) return;
            
            // 设置样式
            const bgColors = {
                'error': 'bg-red-500',
                'success': 'bg-green-500',
                'info': 'bg-blue-500',
                'warning': 'bg-yellow-500'
            };
            
            const bgColor = bgColors[type] || bgColors.error;
            toast.className = `fixed top-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg transform transition-all duration-300 ${bgColor} text-white`;
            toastMessage.textContent = message;
            
            // 显示提示
            toast.style.opacity = '1';
            toast.style.transform = 'translateX(-50%) translateY(0)';
            
            // 3秒后自动隐藏
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(-50%) translateY(-100%)';
            }, 3000);
        }
    </script>
</body>
</html>
