<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>聚合影视搜索</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .search-controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
    .search-controls input, .search-controls select, .search-controls button {
      padding: 8px;
      font-size: 14px;
    }
    #resultList { display: flex; flex-direction: column; gap: 10px; }
    .result-item { border: 1px solid #ccc; padding: 10px; border-radius: 6px; }
    .result-item h4 { margin: 0; }
    #pagination { margin-top: 20px; }
  </style>
</head>
<body>

  <div class="search-controls">
    <input type="text" id="searchInput" placeholder="输入关键词" />
    
    <select id="sourceSelect" onchange="toggleCustomApiInput()">
      <option value="heimuer">默认源（heimuer）</option>
      <option value="ffzy">非凡</option>
      <option value="zuidam3u8">最大</option>
      <option value="custom">自定义API</option>
    </select>

    <input type="text" id="customApiInput" placeholder="自定义API地址" style="display:none;" />

    <select id="yearSelect">
      <option value="">全部年份</option>
    </select>

    <select id="typeSelect">
      <option value="">全部类型</option>
      <option value="电影">电影</option>
      <option value="电视剧">电视剧</option>
      <option value="动漫">动漫</option>
      <option value="韩剧">韩剧</option>
    </select>

    <button onclick="startSearch()">搜索</button>
  </div>

  <div id="resultList"></div>

  <div id="pagination">
    <button onclick="loadNextPage()">下一页</button>
  </div>

  <script>
    let currentPage = 1;
    let currentKeyword = '';

    // 自动填充年份选项
    const yearSelect = document.getElementById('yearSelect');
    const currentYear = new Date().getFullYear();
    for (let y = currentYear; y >= 2000; y--) {
      const opt = document.createElement('option');
      opt.value = y;
      opt.textContent = y;
      yearSelect.appendChild(opt);
    }

    function toggleCustomApiInput() {
      const source = document.getElementById('sourceSelect').value;
      document.getElementById('customApiInput').style.display = source === 'custom' ? 'inline-block' : 'none';
    }

    async function startSearch() {
      currentPage = 1;
      currentKeyword = document.getElementById('searchInput').value.trim();
      await fetchAndRenderResults();
    }

    async function loadNextPage() {
      currentPage++;
      await fetchAndRenderResults();
    }

    async function fetchAndRenderResults() {
      const source = document.getElementById('sourceSelect').value;
      const customApi = document.getElementById('customApiInput').value.trim();
      const year = document.getElementById('yearSelect').value;
      const type = document.getElementById('typeSelect').value;

      let url = `/api/search?wd=${encodeURIComponent(currentKeyword)}&source=${source}&page=${currentPage}`;
      if (source === 'custom' && customApi) {
        url += `&customApi=${encodeURIComponent(customApi)}`;
      }
      if (year) url += `&year=${encodeURIComponent(year)}`;
      if (type) url += `&type=${encodeURIComponent(type)}`;

      try {
        const res = await fetch(url);
        const data = await res.json();

        if (currentPage === 1) {
          document.getElementById('resultList').innerHTML = '';
        }

        if (data.code === 200 && Array.isArray(data.list)) {
          data.list.forEach(item => {
            const div = document.createElement('div');
            div.className = 'result-item';
            div.innerHTML = `
              <h4>${item.vod_name}</h4>
              <p>来源: ${item.source_name}</p>
              <p>类型: ${item.type_name || '未知'} | 年份: ${item.vod_year || '未知'}</p>
              <p><img src="${item.vod_pic}" alt="封面" height="100"/></p>
              <button onclick="viewDetail('${item.vod_id}', '${item.source_code}', '${item.api_url || ''}')">查看详情</button>
            `;
            document.getElementById('resultList').appendChild(div);
          });
        } else {
          document.getElementById('resultList').innerHTML = '<p>没有找到相关内容。</p>';
        }
      } catch (err) {
        console.error('搜索失败：', err);
        alert('搜索失败，请检查API接口或网络');
      }
    }

    async function viewDetail(id, source, customApi) {
      let url = `/api/detail?id=${encodeURIComponent(id)}&source=${source}`;
      if (source === 'custom' && customApi) {
        url += `&customApi=${encodeURIComponent(customApi)}&useDetail=true`;
      }

      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.code === 200) {
          alert(`标题：${data.videoInfo.title}\n播放地址：\n${data.episodes.join('\n')}`);
        } else {
          alert('无法获取详情信息');
        }
      } catch (err) {
        console.error('详情请求失败', err);
        alert('详情请求失败');
      }
    }
  </script>

</body>
</html>
